




  

  

  

  
    
    
    

<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="">

<link rel="apple-touch-icon" sizes="180x180" href="/mc_rtc/assets/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/mc_rtc/assets/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/mc_rtc/assets/favicons/favicon-16x16.png">
<link rel="manifest" href="/mc_rtc/assets/favicons/site.webmanifest">
<link rel="mask-icon" href="/mc_rtc/assets/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js"></script>





<link href="/mc_rtc/css/mc_rtc.css" rel="stylesheet">

    <title>Tutorials - Moving a contact - mc_rtc</title>
  </head>

  <body>
    <header class="navbar navbar-expand-lg navbar-light bg-light sticky-top" role="navigation">
  <a class="navbar-brand" href="/mc_rtc/index.html"><img src="/mc_rtc/assets/logo.png" alt="logo" width="30" height="30"/> mc_rtc</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarText">
    <div class="navbar-nav mr-auto">
      
        
        
        <a class="nav-item nav-link " href="/mc_rtc/interfaces.html">Interfaces</a>
      
        
        
        <a class="nav-item nav-link " href="/mc_rtc/robots.html">Robots</a>
      
        
        
        <a class="nav-item nav-link active" href="/mc_rtc/tutorials.html">Tutorials</a>
      
        
        
        <a class="nav-item nav-link " href="/mc_rtc/doxygen.html">API documentation</a>
      
        
        
        <a class="nav-item nav-link " href="/mc_rtc/json.html">JSON/YAML documentation</a>
      
      <a class="nav-item nav-link" href="https://mc-rtc-demo.netlify.app/" target="blank_">Online demonstration</a>
    </div>
    
      
      
      
      EN
      
      
        &nbsp;|&nbsp;
      
    
      
      
      
        <a href="/mc_rtc/jp/tutorials/recipes/moving-a-contact.html">
      
      JP
      
        </a>
      
      
        &nbsp;&nbsp;&nbsp;
      
    
    <a href="https://github.com/jrl-umi3218/mc_rtc" target="blank_"><svg height="25" width="25" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" aria-hidden="true"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path></svg></a>
  </div>
</header>


    <div class="container-fluid">
      <div class="row">
      <div class="col col-lg-3">
        <div class="sticky-top sticky-toc">
          <div class="accordion" id="accordionTutorials">
            <div class="card">
              <div class="card-header" id="headingOtherTutorials">
                <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapseOtherTutorials" aria-expanded="true" aria-controls="collapseOtherTutorials">
                  Other tutorials
                </button>
              </div>
              <div id="collapseOtherTutorials" class="collapse" arial-labelledby="headingOtherTutorials" data-parent="#accordionTutorials">
                <div class="card-body">
                  <ul>
                    
                    <li>Introduction</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/installation-guide.html">Installation guide</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/configuration.html">Configuring mc_rtc and its components</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/running-a-controller.html">Running a controller</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/first-controller.html">Your first controller with mc_rtc</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/com-controller.html">Controlling the CoM</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/ef-controller.html">Controlling an end-effector (and loading)</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/multi-robot-controller.html">Multi-robot controller</a></li>
                        
                      
                    </ul>
                    
                    <li>Framework usage</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/mc_rtc_configuration.html"><code>mc_rtc::Configuration</code> general purpose configuration</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/logging.html">Logging data</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/console-logging.html">Printing information to the screen</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/gui.html">Graphical User Interface (GUI)</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/live-plotting.html">Display plots live from the controller</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/ros.html">ROS integration</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/global-plugins.html">Using global plugins</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/schema.html">Schema structures integrated to the framework</a></li>
                        
                      
                    </ul>
                    
                    <li>Framework tools</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_rtc_ticker-and-replay.html">mc_rtc_ticker and the Replay plugin</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_log_utils.html">Log manipulation</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_log_ui.html">Log plotting</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_log_visualization.html">Replay visualization</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_surfaces_visualization.html">Visualizing surfaces</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_convex_visualization.html">Visualizing convexes</a></li>
                        
                      
                    </ul>
                    
                    <li>Control recipes</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/fsm.html">Using the FSM facilities</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/fsm-main-states.html">Main FSM states</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/fsm-example.html">FSM controller in practice</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/derived-fsm.html">Deriving the FSM controller</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/datastore.html">DataStore: Sharing Objects</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/observers.html">State Observation Pipelines</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/lipm-stabilizer.html">Using the LIPM Stabilizer</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/speed-constraint.html">Constraint the speed of a body</a></li>
                        
                      
                        
                        <li><strong>Moving a contact</strong></li>
                          
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/contact-dof.html">Change the DoF constraints on a contact</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/joint-select.html">Select specific joints for a task</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/dim-weight.html">Affect different weight to different axis in the task space</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/joint-stiffness.html">Joints Stiffness</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/com-constraint.html">Constraining the accessible region of the CoM</a></li>
                        
                      
                    </ul>
                    
                    <li>Samples</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/samples/list-of-samples.html">Available sample controllers</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/samples/sample-admittance.html">Admittance sample controller</a></li>
                        
                      
                    </ul>
                    
                    <li>Advanced topics</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/new-plugin.html">Implement a new plugin for mc_rtc</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/new-interface.html">Implement a new mc_rtc interface</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/new-environment.html">Environment creation for mc_rtc</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/new-robot.html">Integrate a new robot in mc_rtc</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/support-mc-rtc-build-static.html">Supporting MC_RTC_BUILD_STATIC in your code</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/debug-lssol-output-6.html">Debugging LSSOL output 6</a></li>
                        
                      
                    </ul>
                    
                  </ul>
                </div>
              </div>
              
                <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#simple-implementation">Simple implementation</a></li>
<li class="toc-entry toc-h2"><a href="#using-addremovecontacttask">Using AddRemoveContactTask</a></li>
</ul>
              
            </div>
          </div>
        </div>
      </div>
      <div class="col-9" id="tutorial-content">
        
        <h1>Moving a contact</h1>
        

        <p>Through the various tutorials, you should have an idea of what contacts are, how they are handled in the controller and how you could move a contact. Let’s say that you want to move the left foot from its starting position to another a bit farther away.</p>

<p>The essential steps to do so would be:</p>
<ol>
  <li>Move the CoM above the right foot;</li>
  <li>Remove the left foot contact;</li>
  <li>Move the left foot to the target destination;</li>
  <li>Put the contact back;</li>
</ol>

<p>Let’s implement this simply.</p>

<h2 id="simple-implementation">Simple implementation</h2>

<p>First create an empty controller:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mc_rtc_new_controller MyController MyController
</code></pre></div></div>

<p>Then we will need to modify following elements in our controller:</p>

<ul>
  <li>In <code class="language-plaintext highlighter-rouge">MyController.h</code>:</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// MyController.h</span>
<span class="cp">#pragma once
#include</span> <span class="cpf">&lt;mc_control/mc_controller.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"api.h"</span><span class="cp">
</span><span class="c1">// If we want to use elements in mc_tasks or mc_solver we first must include their header file</span>
<span class="cp">#include</span> <span class="cpf">&lt;mc_tasks/CoMTask.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;mc_tasks/SurfaceTransformTask.h&gt;</span><span class="cp">
</span>
<span class="k">struct</span> <span class="nc">MyController_DLLAPI</span> <span class="n">MyController</span> <span class="o">:</span> <span class="k">public</span> <span class="n">mc_control</span><span class="o">::</span><span class="n">MCController</span>
<span class="p">{</span>
    <span class="n">MyController</span><span class="p">(</span><span class="n">mc_rbdyn</span><span class="o">::</span><span class="n">RobotModulePtr</span> <span class="n">rm</span><span class="p">,</span> <span class="kt">double</span> <span class="n">dt</span><span class="p">,</span> <span class="k">const</span> <span class="n">mc_rtc</span><span class="o">::</span><span class="n">Configuration</span> <span class="o">&amp;</span> <span class="n">config</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">run</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">reset</span><span class="p">(</span><span class="k">const</span> <span class="n">mc_control</span><span class="o">::</span><span class="n">ControllerResetData</span> <span class="o">&amp;</span> <span class="n">reset_data</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

 <span class="nl">protected:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mc_tasks</span><span class="o">::</span><span class="n">CoMTask</span><span class="o">&gt;</span> <span class="n">comTask</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mc_tasks</span><span class="o">::</span><span class="n">SurfaceTransformTask</span><span class="o">&gt;</span> <span class="n">footTask</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">moved_com</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">moved_left_foot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="p">};</span>
</code></pre></div></div>

<ul>
  <li>In <code class="language-plaintext highlighter-rouge">MyController.cpp</code>:</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"MyController.h"</span><span class="cp">
</span>
<span class="n">MyController</span><span class="o">::</span><span class="n">MyController</span><span class="p">(</span><span class="n">mc_rbdyn</span><span class="o">::</span><span class="n">RobotModulePtr</span> <span class="n">rm</span><span class="p">,</span> <span class="kt">double</span> <span class="n">dt</span><span class="p">,</span> <span class="k">const</span> <span class="n">mc_rtc</span><span class="o">::</span><span class="n">Configuration</span> <span class="o">&amp;</span> <span class="cm">/* config */</span><span class="p">)</span>
<span class="o">:</span> <span class="n">mc_control</span><span class="o">::</span><span class="n">MCController</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">solver</span><span class="p">().</span><span class="n">addConstraintSet</span><span class="p">(</span><span class="n">contactConstraint</span><span class="p">);</span>
  <span class="n">solver</span><span class="p">().</span><span class="n">addConstraintSet</span><span class="p">(</span><span class="n">kinematicsConstraint</span><span class="p">);</span>
  <span class="n">solver</span><span class="p">().</span><span class="n">addTask</span><span class="p">(</span><span class="n">postureTask</span><span class="p">);</span>
  <span class="n">addContact</span><span class="p">({</span><span class="n">robot</span><span class="p">().</span><span class="n">name</span><span class="p">(),</span> <span class="s">"ground"</span><span class="p">,</span> <span class="s">"LeftFoot"</span><span class="p">,</span> <span class="s">"AllGround"</span><span class="p">});</span>
  <span class="n">addContact</span><span class="p">({</span><span class="n">robot</span><span class="p">().</span><span class="n">name</span><span class="p">(),</span> <span class="s">"ground"</span><span class="p">,</span> <span class="s">"RightFoot"</span><span class="p">,</span> <span class="s">"AllGround"</span><span class="p">});</span>

  <span class="n">mc_rtc</span><span class="o">::</span><span class="n">log</span><span class="o">::</span><span class="n">success</span><span class="p">(</span><span class="s">"MyController init done "</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">MyController</span><span class="o">::</span><span class="n">run</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">MCController</span><span class="o">::</span><span class="n">run</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">moved_com</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">comTask</span><span class="o">-&gt;</span><span class="n">eval</span><span class="p">().</span><span class="n">norm</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">5e-2</span> <span class="o">&amp;&amp;</span> <span class="n">comTask</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">().</span><span class="n">norm</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">mc_rtc</span><span class="o">::</span><span class="n">log</span><span class="o">::</span><span class="n">success</span><span class="p">(</span><span class="s">"Moved the CoM"</span><span class="p">);</span>
      <span class="n">moved_com</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">removeContact</span><span class="p">({</span><span class="n">robot</span><span class="p">().</span><span class="n">name</span><span class="p">(),</span> <span class="s">"ground"</span><span class="p">,</span> <span class="s">"LeftFoot"</span><span class="p">,</span> <span class="s">"AllGround"</span><span class="p">});</span>
      <span class="n">solver</span><span class="p">().</span><span class="n">addTask</span><span class="p">(</span><span class="n">footTask</span><span class="p">);</span>
      <span class="n">footTask</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">(</span><span class="n">sva</span><span class="o">::</span><span class="n">PTransformd</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">moved_com</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">moved_left_foot</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">footTask</span><span class="o">-&gt;</span><span class="n">eval</span><span class="p">().</span><span class="n">norm</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">5e-2</span> <span class="o">&amp;&amp;</span> <span class="n">footTask</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">().</span><span class="n">norm</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">mc_rtc</span><span class="o">::</span><span class="n">log</span><span class="o">::</span><span class="n">success</span><span class="p">(</span><span class="s">"Moved the left foot"</span><span class="p">);</span>
      <span class="n">moved_left_foot</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">addContact</span><span class="p">({</span><span class="n">robot</span><span class="p">().</span><span class="n">name</span><span class="p">(),</span> <span class="s">"ground"</span><span class="p">,</span> <span class="s">"LeftFoot"</span><span class="p">,</span> <span class="s">"AllGround"</span><span class="p">});</span>
      <span class="n">solver</span><span class="p">().</span><span class="n">removeTask</span><span class="p">(</span><span class="n">footTask</span><span class="p">);</span>
      <span class="k">auto</span> <span class="n">com</span> <span class="o">=</span> <span class="n">comTask</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">();</span>

      <span class="n">com</span><span class="p">.</span><span class="n">x</span><span class="p">()</span> <span class="o">=</span>
        <span class="p">(</span><span class="n">robot</span><span class="p">().</span><span class="n">surfacePose</span><span class="p">(</span><span class="s">"LeftFoot"</span><span class="p">).</span><span class="n">translation</span><span class="p">().</span><span class="n">x</span><span class="p">()</span>
         <span class="o">+</span>
         <span class="n">robot</span><span class="p">().</span><span class="n">surfacePose</span><span class="p">(</span><span class="s">"RightFoot"</span><span class="p">).</span><span class="n">translation</span><span class="p">().</span><span class="n">x</span><span class="p">())</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

      <span class="n">com</span><span class="p">.</span><span class="n">y</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">comTask</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">(</span><span class="n">com</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">MyController</span><span class="o">::</span><span class="n">reset</span><span class="p">(</span><span class="k">const</span> <span class="n">mc_control</span><span class="o">::</span><span class="n">ControllerResetData</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">MCController</span><span class="o">::</span><span class="n">reset</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
  <span class="cm">/* Create the task */</span>
  <span class="n">comTask</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">mc_tasks</span><span class="o">::</span><span class="n">CoMTask</span><span class="o">&gt;</span><span class="p">(</span><span class="n">robots</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">footTask</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">mc_tasks</span><span class="o">::</span><span class="n">SurfaceTransformTask</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"LeftFoot"</span><span class="p">,</span> <span class="n">robots</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>
  <span class="cm">/* Move the CoM above the right foot */</span>
  <span class="n">comTask</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">(</span><span class="n">comTask</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">()</span> <span class="o">+</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">footTask</span><span class="o">-&gt;</span><span class="n">surfacePose</span><span class="p">().</span><span class="n">translation</span><span class="p">().</span><span class="n">y</span><span class="p">(),</span> <span class="mi">0</span><span class="p">));</span>
  <span class="cm">/* Add the CoM task to the solver */</span>
  <span class="n">solver</span><span class="p">().</span><span class="n">addTask</span><span class="p">(</span><span class="n">comTask</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">CONTROLLER_CONSTRUCTOR</span><span class="p">(</span><span class="s">"MyController"</span><span class="p">,</span> <span class="n">MyController</span><span class="p">)</span>
</code></pre></div></div>

<p>What you will notice is that the robot “slides” its feet along the floor. That’s because this is the most direct way to go to the desired position. There is many ways this could be solved but we will now cover two useful <code class="language-plaintext highlighter-rouge">MetaTask</code> that take care of such scenarios:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">AddRemoveContactTask</code> which we will use to remove and add the left foot contact</li>
  <li><code class="language-plaintext highlighter-rouge">MoveContactTask</code> which we will use to move the foot between the two points</li>
</ul>

<h2 id="using-addremovecontacttask">Using <code class="language-plaintext highlighter-rouge">AddRemoveContactTask</code></h2>

<p>To use <code class="language-plaintext highlighter-rouge">AddRemoveContactTask</code> we need a <a href="/mc_rtc/tutorials/recipes/speed-constraint.html">BoundedSpeedConstraint</a> in the solver. We will also need the task itself. Finally, we need two supplementary steps to remove and add back the foot. So, we will modify our controller header and the <code class="language-plaintext highlighter-rouge">reset()</code> function accordingly:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// In the header</span>
<span class="cp">#include</span> <span class="cpf">&lt;mc_solver/BoundedSpeedConstr.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;mc_tasks/AddRemoveContactTask.h&gt;</span><span class="cp">
</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mc_solver</span><span class="o">::</span><span class="n">BoundedSpeedConstr</span><span class="o">&gt;</span> <span class="n">bSpeedConstr</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mc_tasks</span><span class="o">::</span><span class="n">AddRemoveContactTask</span><span class="o">&gt;</span> <span class="n">aRContactTask</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">removed_left_foot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">added_left_foot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// In reset</span>
<span class="n">bSpeedConstr</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">mc_solver</span><span class="o">::</span><span class="n">BoundedSpeedConstr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">robots</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">);</span>
<span class="n">solver</span><span class="p">().</span><span class="n">addConstraintSet</span><span class="p">(</span><span class="o">*</span><span class="n">bSpeedConstr</span><span class="p">);</span>
</code></pre></div></div>

<p>For the removal, we will use the <code class="language-plaintext highlighter-rouge">RemoveContactTask</code> specialization of <code class="language-plaintext highlighter-rouge">AddRemoveContactTask</code>, the prototype is:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">RemoveContactTask</span><span class="p">(</span><span class="n">mc_rbdyn</span><span class="o">::</span><span class="n">Robots</span> <span class="o">&amp;</span> <span class="n">robots</span><span class="p">,</span>
                 <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mc_solver</span><span class="o">::</span><span class="n">BoundedSpeedConstr</span><span class="o">&gt;</span> <span class="n">constSpeedConstr</span><span class="p">,</span>
                 <span class="n">mc_rbdyn</span><span class="o">::</span><span class="n">Contact</span> <span class="o">&amp;</span> <span class="n">contact</span><span class="p">,</span>
                 <span class="kt">double</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">double</span> <span class="n">stiffness</span><span class="p">,</span> <span class="kt">double</span> <span class="n">weight</span><span class="p">,</span>
                 <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="o">*</span> <span class="n">userT_0_s</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">);</span>
</code></pre></div></div>

<p>To add the contact, we will use the <code class="language-plaintext highlighter-rouge">AddContactTask</code> specialization, whose prototype is:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">AddContactTask</span><span class="p">(</span><span class="n">mc_rbdyn</span><span class="o">::</span><span class="n">Robots</span> <span class="o">&amp;</span> <span class="n">robots</span><span class="p">,</span>
                 <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">mc_solver</span><span class="o">::</span><span class="n">BoundedSpeedConstr</span><span class="o">&gt;</span> <span class="n">constSpeedConstr</span><span class="p">,</span>
                 <span class="n">mc_rbdyn</span><span class="o">::</span><span class="n">Contact</span> <span class="o">&amp;</span> <span class="n">contact</span><span class="p">,</span>
                 <span class="kt">double</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">double</span> <span class="n">stiffness</span><span class="p">,</span> <span class="kt">double</span> <span class="n">weight</span><span class="p">,</span>
                 <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="o">*</span> <span class="n">userT_0_s</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">);</span>
</code></pre></div></div>

<p>For both cases, the arguments are pretty similar, the most importants are:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">mc_rbdyn::Contact &amp; contact</code> which should be the contact we want to add or remove</li>
  <li><code class="language-plaintext highlighter-rouge">double speed</code> which is the insertion/removal speed</li>
</ul>

<p>Note that, this task does not take care of actually maintaing the contact list in the solver nor does it take care of collision avoidance so we will need to take care of that ourselves.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bool</span> <span class="n">MyController</span><span class="o">::</span><span class="n">run</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">MCController</span><span class="o">::</span><span class="n">run</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">moved_com</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">comTask</span><span class="o">-&gt;</span><span class="n">eval</span><span class="p">().</span><span class="n">norm</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">5e-2</span> <span class="o">&amp;&amp;</span> <span class="n">comTask</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">().</span><span class="n">norm</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">mc_rtc</span><span class="o">::</span><span class="n">log</span><span class="o">::</span><span class="n">success</span><span class="p">(</span><span class="s">"Moved the CoM"</span><span class="p">);</span>
      <span class="n">moved_com</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">removeContact</span><span class="p">({</span><span class="n">robot</span><span class="p">().</span><span class="n">name</span><span class="p">(),</span> <span class="s">"ground"</span><span class="p">,</span> <span class="s">"LeftFoot"</span><span class="p">,</span> <span class="s">"AllGround"</span><span class="p">});</span>
      <span class="n">mc_rbdyn</span><span class="o">::</span><span class="n">Contact</span> <span class="n">rmContact</span><span class="p">(</span><span class="n">robots</span><span class="p">(),</span> <span class="s">"LeftFoot"</span><span class="p">,</span> <span class="s">"AllGround"</span><span class="p">);</span>
      <span class="n">aRContactTask</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">mc_tasks</span><span class="o">::</span><span class="n">RemoveContactTask</span><span class="p">(</span><span class="n">robots</span><span class="p">(),</span>
                                                          <span class="n">bSpeedConstr</span><span class="p">,</span>
                                                          <span class="n">rmContact</span><span class="p">,</span>
                                                          <span class="mf">0.05</span><span class="p">,</span>
                                                          <span class="mf">2.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">));</span>
      <span class="n">solver</span><span class="p">().</span><span class="n">addTask</span><span class="p">(</span><span class="n">aRContactTask</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">moved_com</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">removed_left_foot</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/* Monitor the foot altitude */</span>
    <span class="kt">double</span> <span class="n">lf_z</span> <span class="o">=</span> <span class="n">robot</span><span class="p">().</span><span class="n">surfacePose</span><span class="p">(</span><span class="s">"LeftFoot"</span><span class="p">).</span><span class="n">translation</span><span class="p">().</span><span class="n">z</span><span class="p">();</span>
    <span class="kt">double</span> <span class="n">rf_z</span> <span class="o">=</span> <span class="n">robot</span><span class="p">().</span><span class="n">surfacePose</span><span class="p">(</span><span class="s">"RightFoot"</span><span class="p">).</span><span class="n">translation</span><span class="p">().</span><span class="n">z</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">lf_z</span> <span class="o">&gt;</span> <span class="n">rf_z</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">mc_rtc</span><span class="o">::</span><span class="n">log</span><span class="o">::</span><span class="n">success</span><span class="p">(</span><span class="s">"Left foot contact removed"</span><span class="p">);</span>
      <span class="n">removed_left_foot</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">solver</span><span class="p">().</span><span class="n">removeTask</span><span class="p">(</span><span class="n">aRContactTask</span><span class="p">);</span>
      <span class="n">solver</span><span class="p">().</span><span class="n">addTask</span><span class="p">(</span><span class="n">footTask</span><span class="p">);</span>
      <span class="n">footTask</span><span class="o">-&gt;</span><span class="n">add_ef_pose</span><span class="p">(</span><span class="n">sva</span><span class="o">::</span><span class="n">PTransformd</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">removed_left_foot</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">moved_left_foot</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">footTask</span><span class="o">-&gt;</span><span class="n">eval</span><span class="p">().</span><span class="n">norm</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">5e-2</span> <span class="o">&amp;&amp;</span> <span class="n">footTask</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">().</span><span class="n">norm</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">mc_rtc</span><span class="o">::</span><span class="n">log</span><span class="o">::</span><span class="n">success</span><span class="p">(</span><span class="s">"Moved the left foot"</span><span class="p">);</span>
      <span class="n">moved_left_foot</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">solver</span><span class="p">().</span><span class="n">removeTask</span><span class="p">(</span><span class="n">footTask</span><span class="p">);</span>
      <span class="n">mc_rbdyn</span><span class="o">::</span><span class="n">Contact</span> <span class="n">addContact</span><span class="p">(</span><span class="n">robots</span><span class="p">(),</span> <span class="s">"LeftFoot"</span><span class="p">,</span> <span class="s">"AllGround"</span><span class="p">);</span>
      <span class="n">aRContactTask</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">mc_tasks</span><span class="o">::</span><span class="n">AddContactTask</span><span class="p">(</span><span class="n">robots</span><span class="p">(),</span>
                                                       <span class="n">bSpeedConstr</span><span class="p">,</span>
                                                       <span class="n">addContact</span><span class="p">,</span>
                                                       <span class="mf">0.05</span><span class="p">,</span>
                                                       <span class="mf">2.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">));</span>
      <span class="n">solver</span><span class="p">().</span><span class="n">addTask</span><span class="p">(</span><span class="n">aRContactTask</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">moved_left_foot</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">added_left_foot</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/* Monitor the foot altitude */</span>
    <span class="kt">double</span> <span class="n">lf_z</span> <span class="o">=</span> <span class="n">robot</span><span class="p">().</span><span class="n">surfacePose</span><span class="p">(</span><span class="s">"LeftFoot"</span><span class="p">).</span><span class="n">translation</span><span class="p">().</span><span class="n">z</span><span class="p">();</span>
    <span class="kt">double</span> <span class="n">rf_z</span> <span class="o">=</span> <span class="n">robot</span><span class="p">().</span><span class="n">surfacePose</span><span class="p">(</span><span class="s">"RightFoot"</span><span class="p">).</span><span class="n">translation</span><span class="p">().</span><span class="n">z</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">lf_z</span> <span class="o">-</span> <span class="n">rf_z</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">mc_rtc</span><span class="o">::</span><span class="n">log</span><span class="o">::</span><span class="n">success</span><span class="p">(</span><span class="s">"Added left foot"</span><span class="p">);</span>
      <span class="n">added_left_foot</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">solver</span><span class="p">().</span><span class="n">removeTask</span><span class="p">(</span><span class="n">aRContactTask</span><span class="p">);</span>
      <span class="n">addContact</span><span class="p">({</span><span class="n">robot</span><span class="p">().</span><span class="n">name</span><span class="p">(),</span> <span class="s">"ground"</span><span class="p">,</span> <span class="s">"LeftFoot"</span><span class="p">,</span> <span class="s">"AllGround"</span><span class="p">});</span>
      <span class="k">auto</span> <span class="n">com</span> <span class="o">=</span> <span class="n">comTask</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">();</span>

      <span class="n">com</span><span class="p">.</span><span class="n">x</span><span class="p">()</span> <span class="o">=</span>
        <span class="p">(</span><span class="n">robot</span><span class="p">().</span><span class="n">surfacePose</span><span class="p">(</span><span class="s">"LeftFoot"</span><span class="p">).</span><span class="n">translation</span><span class="p">().</span><span class="n">x</span><span class="p">()</span>
         <span class="o">+</span>
         <span class="n">robot</span><span class="p">().</span><span class="n">surfacePose</span><span class="p">(</span><span class="s">"RightFoot"</span><span class="p">).</span><span class="n">translation</span><span class="p">().</span><span class="n">x</span><span class="p">())</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

      <span class="n">com</span><span class="p">.</span><span class="n">y</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">comTask</span><span class="o">-&gt;</span><span class="n">com</span><span class="p">(</span><span class="n">com</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>



        <hr/>
        
        <div class="text-right">
          <a href="/mc_rtc/tutorials/recipes/contact-dof.html">Next tutorial: Change the DoF constraints on a contact</a>
        </div>
        
      </div>
      </div>
    </div>

    <div class="container-fluid">
  <footer>
    <hr>
    <div class="row">
      <div class="col-8 offset-lg-2 col-lg-6">
        Copyright &copy; CNRS-AIST JRL, CNRS LIRMM 2015-2020
      </div>
      <div class="col-4 col-lg-2 text-right">
        <a href="/mc_rtc/credits.html">Credits</a>
      </div>
    </div>
  </footer>
</div>

  </body>

  <script type="text/javascript">
$(document).ready(function()
{
  new ClipboardJS('.copy-button');
});
</script>


</html>
