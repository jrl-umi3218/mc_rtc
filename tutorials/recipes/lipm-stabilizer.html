




  

  

  

  
    
    
    

<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Tutorials - Using the LIPM Stabilizer - mc_rtc</title>

    <link rel="apple-touch-icon" sizes="180x180" href="/mc_rtc/assets/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/mc_rtc/assets/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/mc_rtc/assets/favicons/favicon-16x16.png">
    <link rel="manifest" href="/mc_rtc/assets/favicons/site.webmanifest">
    <link rel="mask-icon" href="/mc_rtc/assets/favicons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/8.0.0/build.css" integrity="sha256-iPUhChwurLRCrDCM1+2a2LDe9pfW6Je29o/oA5VPr28=" crossorigin="anonymous" />

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js"></script>

    

    

    <link href="/mc_rtc/css/mc_rtc.css" rel="stylesheet">
  </head>

  <body>
    <header class="navbar navbar-expand-lg navbar-light bg-light sticky-top" role="navigation">
      <a class="navbar-brand" href="/mc_rtc/index.html"><img src="/mc_rtc/assets/logo.png" alt="logo" width="30" height="30"/> mc_rtc</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarText">
        <div class="navbar-nav mr-auto">
          
          
          
          <a class="nav-item nav-link " href="/mc_rtc/interfaces.html">Interfaces</a>
          
          
          
          
          <a class="nav-item nav-link " href="/mc_rtc/robots.html">Robots</a>
          
          
          
          
          <a class="nav-item nav-link active" href="/mc_rtc/tutorials.html">Tutorials</a>
          
          
          
          
          <a class="nav-item nav-link " href="/mc_rtc/doxygen.html">API documentation</a>
          
          
          
          
          <a class="nav-item nav-link " href="/mc_rtc/json.html">JSON/YAML documentation</a>
          
          
        </div>
        <a href="https://github.com/jrl-umi3218/mc_rtc" target="blank_"><svg height="25" width="25" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg></a>
      </div>
    </header>

    <div class="container-fluid">
      <div class="row">
      <div class="col col-lg-3">
        <div class="sticky-top sticky-toc">
          <div class="accordion" id="accordionTutorials">
            <div class="card">
              <div class="card-header" id="headingOtherTutorials">
                <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapseOtherTutorials" aria-expanded="true" aria-controls="collapseOtherTutorials">
                  Other tutorials
                </button>
              </div>
              <div id="collapseOtherTutorials" class="collapse" arial-labelledby="headingOtherTutorials" data-parent="#accordionTutorials">
                <div class="card-body">
                  <ul>
                    
                    <li>Introduction</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/installation-guide.html">Installation guide</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/configuration.html">Configuring mc_rtc</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/running-a-controller.html">Running a controller</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/first-controller.html">Your first controller with mc_rtc</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/com-controller.html">Controlling the CoM</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/ef-controller.html">Controlling an end-effector (and loading)</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/multi-robot-controller.html">Multi-robot controller</a></li>
                        
                      
                    </ul>
                    
                    <li>Framework usage</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/mc_rtc_configuration.html"><code>mc_rtc::Configuration</code> general purpose configuration</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/logging.html">Logging data</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/console-logging.html">Printing information to the screen</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/gui.html">Graphical User Interface (GUI)</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/live-plotting.html">Display plots live from the controller</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/ros.html">ROS integration</a></li>
                        
                      
                    </ul>
                    
                    <li>Framework tools</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_log_utils.html">Log manipulation</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_log_ui.html">Log plotting</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_log_visualization.html">Replay visualization</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_surfaces_visualization.html">Visualizing surfaces</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_convex_visualization.html">Visualizing convexes</a></li>
                        
                      
                    </ul>
                    
                    <li>Control recipes</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/fsm.html">Using the FSM facilities</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/fsm-main-states.html">Main FSM states</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/fsm-example.html">FSM controller in practice</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/derived-fsm.html">Deriving the FSM controller</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/datastore.html">DataStore: Sharing Objects</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/observers.html">State Observation Pipelines</a></li>
                        
                      
                        
                        <li><strong>Using the LIPM Stabilizer</strong></li>
                          
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/speed-constraint.html">Constraint the speed of a body</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/moving-a-contact.html">Moving a contact</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/contact-dof.html">Change the DoF constraints on a contact</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/joint-select.html">Select specific joints for a task</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/dim-weight.html">Affect different weight to different axis in the task space</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/joint-stiffness.html">Joints Stiffness</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/com-constraint.html">Constraining the accessible region of the CoM</a></li>
                        
                      
                    </ul>
                    
                    <li>Samples</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/samples/sample-admittance.html">Admittance sample controller</a></li>
                        
                      
                    </ul>
                    
                    <li>Advanced topics</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/new-interface.html">Implement a new mc_rtc interface</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/new-environment.html">Environment creation for mc_rtc</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/new-robot.html">Integrate a new robot in mc_rtc</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/support-mc-rtc-build-static.html">Supporting MC_RTC_BUILD_STATIC in your code</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/debug-lssol-output-6.html">Debugging LSSOL output 6</a></li>
                        
                      
                    </ul>
                    
                  </ul>
                </div>
              </div>
              <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#a-bit-of-history">A bit of history</a></li>
<li class="toc-entry toc-h2"><a href="#overview-of-the-stabilizer">Overview of the stabilizer</a></li>
<li class="toc-entry toc-h2"><a href="#state-observation">State observation</a></li>
<li class="toc-entry toc-h2"><a href="#configuring-the-gains">Configuring the gains</a></li>
<li class="toc-entry toc-h2"><a href="#using-the-stabilizer-manually">Using the Stabilizer (Manually)</a></li>
<li class="toc-entry toc-h2"><a href="#using-the-stabilizer-fsm">Using the Stabilizer (FSM)</a></li>
<li class="toc-entry toc-h2"><a href="#lipmstabilizer-sample-fsm">LIPMStabilizer sample FSM</a></li>
<li class="toc-entry toc-h2"><a href="#interacting-with-the-stabilizer-from-another-fsm-states">Interacting with the stabilizer from another FSM states</a></li>
</ul>
            </div>
          </div>
        </div>
      </div>
      <div class="col-9" id="tutorial-content">
        <h1>Using the LIPM Stabilizer</h1>

        <h2 id="a-bit-of-history">A bit of history</h2>

<p>The stabilizer presented in this tutorial was originally implemented as part of Dr. Stéphane Caron’s <a href="https://github.com/stephane-caron/lipm_walking_controller">LIPM Walking Controller</a>. This implementation has been intensively used for walking, including stair climbing and extensive locomotion, notably as part of an Airbus’ manufacturing use-case performed in-situ at their industrial factory. The implementation proposed in <code class="language-plaintext highlighter-rouge">mc_tasks::lipm_stabilizer::StabilizerTask</code> is an integration of the method proposed in Dr. Caron’s original implementation. No significant conceptual alteration to the stabilization algorithm were made. Walking is currently provided in a separate  <a href="https://github.com/jrl-umi3218/lipm_walking_controller">controller</a>.</p>

<div class="embed-responsive embed-responsive-16by9">
  <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/vFCFKAunsYM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
</div>

<h2 id="overview-of-the-stabilizer">Overview of the stabilizer</h2>

<p>For details on the stabilization algorithm, please refer to the original publication by Stéphane Caron, Abderrahmane Kheddar and Olivier Tempier: <a href="https://scaron.info/publications/icra-2019.html">Stair Climbing Stabilization of the HRP-4 Humanoid Robot using Whole-body Admittance Control</a> published at <em>ICRA 2019, Montreal, Canada, May 2019.</em></p>

<p>This stabilizer is implemented here in <code class="language-plaintext highlighter-rouge">mc_tasks::lipm_stabilizer::StabilizerTask</code> as a <code class="language-plaintext highlighter-rouge">MetaTask</code>, i.e a task that manages the following additional tasks:</p>

<ul>
  <li>A <code class="language-plaintext highlighter-rouge">CoMTask</code> to track the desired CoM position computed by the stabilizer</li>
  <li>Two <code class="language-plaintext highlighter-rouge">CoPTask</code> to track desired wrench under each of the robot’s feet</li>
  <li>Two <code class="language-plaintext highlighter-rouge">OrientationTasks</code> on respectively the waist and torso bodies, used for regularization of the upper-body behaviour</li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">StabilizerTask</code> role is to compute targets to provide to these tasks such that the real robot system tracks as-best-as-possible the behaviour of a reference linear inverted pendulum model. As such, to stabilize dynamic trajectories, the user must provide the following inputs to the stabilizer:</p>

<ul>
  <li>Position of the desired <code class="language-plaintext highlighter-rouge">CoM</code></li>
  <li>Velocity of the desired <code class="language-plaintext highlighter-rouge">CoM</code></li>
  <li>Acceleration of the desired <code class="language-plaintext highlighter-rouge">CoM</code></li>
  <li>Position of the desired <code class="language-plaintext highlighter-rouge">ZMP</code></li>
</ul>

<p>This full reference state can be provided by:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">StabilizerTask</span><span class="o">::</span><span class="n">target</span><span class="p">(</span>
            <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="o">&amp;</span> <span class="n">com</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="o">&amp;</span> <span class="n">comd</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="o">&amp;</span> <span class="n">comdd</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="o">&amp;</span> <span class="n">zmp</span><span class="p">);</span>
</code></pre></div></div>

<p>For convenience, a helper function is provided to give appropriate pendulum targets for static position. It is important to note that this helper is only suitable to make the stabilizer keep the robot in a given configuration, but should not be used for dynamically moving the CoM.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">StabilizerTask</span><span class="o">::</span><span class="n">staticTarget</span><span class="p">(</span><span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="o">&amp;</span> <span class="n">com</span><span class="p">,</span> <span class="kt">double</span> <span class="n">zmpHeight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>

<p>It is your responsibility to provide a valid reference state. In case of walking, this is typically computed by a Model Predictive Controller (MPC) such that dynamic stability is ensured in-between footsteps.</p>

<h2 id="state-observation">State observation</h2>

<p>The aim of the stabilizer is to make the real system track the desired reference pendulum. As such, it requires the observation of the following real robot state:</p>

<ul>
  <li>Position of the <code class="language-plaintext highlighter-rouge">CoM</code></li>
  <li>Velocity of the <code class="language-plaintext highlighter-rouge">CoM</code></li>
  <li>Contact wrenches</li>
</ul>

<p>You must setup a suitable <a href="observers.html">observer pipeline</a> to estimate the required quantities. The following pipeline can be used, it is equivalent to the original implementation:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Observes real robot state</span>
<span class="na">RunObservers</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Encoder</span><span class="pi">,</span> <span class="nv">KinematicInertial</span><span class="pi">]</span>
<span class="c1"># Updates the Controller::realRobot() instance from the observed state</span>
<span class="na">UpdateObservers</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Encoder</span><span class="pi">,</span> <span class="nv">KinematicInertial</span><span class="pi">]</span>
</code></pre></div></div>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">Encoder</code> observer computes the body position and velocities based on encoder measurements</li>
  <li>The <code class="language-plaintext highlighter-rouge">KinematicInertial</code> observer computes the floating base’s pose and its velocity based on IMU measurement and a reference anchor frame provided in-between the robot’s feet.</li>
</ul>

<p><strong>Important note:</strong> you are expected to provide a valid continuous anchor frame. For simplicity, the stabilizer implementation provides it as</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sva</span><span class="o">::</span><span class="n">PTransformd</span> <span class="n">anchorFrame</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
<span class="n">sva</span><span class="o">::</span><span class="n">PTransformd</span> <span class="n">anchorFrameReal</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
</code></pre></div></div>

<p>For now these values must be manually passed at each iteration to the <code class="language-plaintext highlighter-rouge">KinematicInertial</code> observer by calling:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mc_controller</span><span class="o">::</span><span class="n">Controller</span> <span class="o">&amp;</span> <span class="n">ctl</span> <span class="o">=</span> <span class="p">...;</span> <span class="c1">// Controller's instance</span>
<span class="n">mc_tasks</span><span class="o">::</span><span class="n">lipm_stabilizer</span><span class="o">::</span><span class="n">StabilizerTask</span> <span class="o">&amp;</span> <span class="n">stabilizer</span> <span class="o">=</span> <span class="p">...;</span> <span class="c1">// Stabilizer instance</span>
<span class="n">ctl</span><span class="p">.</span><span class="n">anchorFrame</span><span class="p">(</span><span class="n">stabilizer</span><span class="p">.</span><span class="n">anchorFrame</span><span class="p">());</span>
<span class="n">ctl</span><span class="p">.</span><span class="n">anchorFrameReal</span><span class="p">(</span><span class="n">stabilizer</span><span class="p">.</span><span class="n">anchorFrameReal</span><span class="p">());</span>
</code></pre></div></div>

<p>With this, the observer pipeline will automatically update the <code class="language-plaintext highlighter-rouge">realRobot()</code> instance with the estimated state, which the stabilizer task will use to compute the tasks’ targets.</p>

<h2 id="configuring-the-gains">Configuring the gains</h2>

<p>The following parameters determines how the stabilizer reacts to observed perturbation of the desired pendulum state.
See <a href="https://jrl-umi3218.github.io/lipm_walking_controller/doxygen/HEAD/stabilizer.html">Stephane’s documentaion</a> to learn more about how to tune those gains.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">####</span>
<span class="c1"># Sample stabilizer configuration for the JVRC robot</span>
<span class="c1"># The most important entries are the</span>
<span class="c1"># - dcm_tracking: controls how the stabilizer reacts to perturbation of the DCM</span>
<span class="c1"># - admittance: controls the contact admittance</span>
<span class="c1">###</span>
<span class="c1"># Sole-floor friction coefficient</span>
<span class="na">friction</span><span class="pi">:</span> <span class="m">0.7</span>
<span class="c1"># Configuration of the tasks managed by the stabilizer</span>
<span class="na">tasks</span><span class="pi">:</span>
  <span class="na">com</span><span class="pi">:</span>
    <span class="na">stiffness</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">1000</span><span class="pi">,</span> <span class="nv">1000</span><span class="pi">,</span> <span class="nv">100</span><span class="pi">]</span>
    <span class="na">weight</span><span class="pi">:</span> <span class="m">1000</span>
    <span class="na">active_joints</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Root</span><span class="pi">,</span>
                    <span class="nv">R_HIP_Y</span><span class="pi">,</span> <span class="nv">R_HIP_R</span><span class="pi">,</span> <span class="nv">R_HIP_P</span><span class="pi">,</span> <span class="nv">R_KNEE</span><span class="pi">,</span> <span class="nv">R_ANKLE_P</span><span class="pi">,</span> <span class="nv">R_ANKLE_R</span><span class="pi">,</span>
                    <span class="nv">L_HIP_Y</span><span class="pi">,</span> <span class="nv">L_HIP_R</span><span class="pi">,</span> <span class="nv">L_HIP_P</span><span class="pi">,</span> <span class="nv">L_KNEE</span><span class="pi">,</span> <span class="nv">L_ANKLE_P</span><span class="pi">,</span> <span class="nv">L_ANKLE_R</span><span class="pi">]</span>
    <span class="na">height</span><span class="pi">:</span> <span class="m">0.85</span>
  <span class="na">contact</span><span class="pi">:</span>
    <span class="na">damping</span><span class="pi">:</span> <span class="m">300</span>
    <span class="na">stiffness</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">weight</span><span class="pi">:</span> <span class="m">10000</span>
  <span class="na">pelvis</span><span class="pi">:</span>
    <span class="na">stiffness</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">weight</span><span class="pi">:</span> <span class="m">100</span>
  <span class="na">torso</span><span class="pi">:</span>
    <span class="na">stiffness</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">weight</span><span class="pi">:</span> <span class="m">100</span>
    <span class="na">pitch</span><span class="pi">:</span> <span class="m">0</span>
<span class="na">fdqp_weights</span><span class="pi">:</span>
  <span class="na">net_wrench</span><span class="pi">:</span> <span class="m">10000</span>
  <span class="na">ankle_torque</span><span class="pi">:</span> <span class="m">100</span>
  <span class="na">pressure</span><span class="pi">:</span> <span class="m">1</span>
<span class="na">vdc</span><span class="pi">:</span>
  <span class="na">frequency</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">stiffness</span><span class="pi">:</span> <span class="m">1000</span>
<span class="na">admittance</span><span class="pi">:</span>
  <span class="na">cop</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0.01</span><span class="pi">,</span> <span class="nv">0.01</span><span class="pi">]</span>
  <span class="na">dfz</span><span class="pi">:</span> <span class="m">0.0001</span>
  <span class="na">dfz_damping</span><span class="pi">:</span> <span class="m">0</span>
<span class="na">dcm_tracking</span><span class="pi">:</span>
  <span class="na">gains</span><span class="pi">:</span>
    <span class="na">prop</span><span class="pi">:</span> <span class="m">5.0</span>
    <span class="na">integral</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">deriv</span><span class="pi">:</span> <span class="m">0.5</span>
  <span class="na">derivator_time_constant</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">integrator_time_constant</span><span class="pi">:</span> <span class="m">10</span>

<span class="c1"># If you are using the same configuration file with different robots, you can provide per-robot configuration as well</span>
<span class="na">jvrc1</span><span class="pi">:</span>
  <span class="na">admittance</span><span class="pi">:</span>
    <span class="na">cop</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0.02</span><span class="pi">,</span> <span class="nv">0.02</span><span class="pi">]</span>

</code></pre></div></div>

<p>Looks daunting? Don’t worry, you most likely won’t need to provide those gains explicitely, unless you are tuning the stabilizer for a new robot. A default stabilizer configuration must be provided by the <code class="language-plaintext highlighter-rouge">RobotModule</code> and can be accessed within your controller by</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mc_rbdyn</span><span class="o">::</span><span class="n">lipm_stabilizer</span><span class="o">::</span><span class="n">StabilizerConfiguration</span> <span class="n">stabiConf</span> <span class="o">=</span> <span class="n">robot</span><span class="p">().</span><span class="n">module</span><span class="p">().</span><span class="n">defaultLIPMStabilizerConfiguration</span><span class="p">();</span>
</code></pre></div></div>

<p>You can easily load the task from configuration:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">stabilizerTask</span> <span class="o">=</span> <span class="n">mc_tasks</span><span class="o">::</span><span class="n">MetaTaskLoader</span><span class="o">::</span><span class="n">load</span><span class="o">&lt;</span><span class="n">mc_tasks</span><span class="o">::</span><span class="n">lipm_stabilizer</span><span class="o">::</span><span class="n">StabilizerTask</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ctl</span><span class="p">.</span><span class="n">solver</span><span class="p">(),</span> <span class="n">config</span><span class="p">);</span>
<span class="n">ctl</span><span class="p">.</span><span class="n">solver</span><span class="p">().</span><span class="n">addTask</span><span class="p">(</span><span class="n">stabilizerTask</span><span class="p">);</span>
</code></pre></div></div>

<p>When doing so, the stabilizer is configured in the following way:</p>

<ul>
  <li>Default configuration from the <code class="language-plaintext highlighter-rouge">RobotModule::defaultLIPMStabilizerConfiguration()</code>. A valid configuration is provided for all <a href="/mc_rtc/robots.html">robots</a> supported by <code class="language-plaintext highlighter-rouge">mc_rtc</code>.</li>
  <li>YAML configuration for the task</li>
  <li>Per-robot YAML configuration can be used to modify any of these values for a specific robot.</li>
</ul>

<p>See the <a href="../../json.html#MetaTask/LIPMStabilizerTask">JSON schema</a> for details on the YAML configuration format.</p>

<h2 id="using-the-stabilizer-manually">Using the Stabilizer (Manually)</h2>

<p>To create a stabilizer task within your own controller, you simply need to instanciate the <code class="language-plaintext highlighter-rouge">mc_tasks::lipm_stabilizer::StabilizerTask</code>, and</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Load default configuration from robot module</span>
<span class="k">auto</span> <span class="n">stabiConf</span> <span class="o">=</span> <span class="n">robot</span><span class="p">().</span><span class="n">module</span><span class="p">().</span><span class="n">defaultLIPMStabilizerConfiguration</span><span class="p">();</span>
<span class="c1">// Create the stabilizer task</span>
<span class="k">auto</span> <span class="n">t</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">mc_tasks</span><span class="o">::</span><span class="n">lipm_stabilizer</span><span class="o">::</span><span class="n">StabilizerTask</span><span class="o">&gt;</span><span class="p">(</span>
          <span class="n">solver</span><span class="p">().</span><span class="n">robots</span><span class="p">(),</span>
          <span class="n">solver</span><span class="p">().</span><span class="n">realRobots</span><span class="p">(),</span>
          <span class="n">robotIndex</span><span class="p">,</span>
          <span class="n">stabiConf</span><span class="p">.</span><span class="n">leftFootSurface</span><span class="p">,</span>
          <span class="n">stabiConf</span><span class="p">.</span><span class="n">rightFootSurface</span><span class="p">,</span>
          <span class="n">stabiConf</span><span class="p">.</span><span class="n">torsoBodyName</span><span class="p">,</span>
          <span class="n">solver</span><span class="p">().</span><span class="n">dt</span><span class="p">());</span>
<span class="c1">// Reset the task targets and default configuration</span>
<span class="n">t</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">();</span>
<span class="c1">// Apply stabilizer configuration (optional, if not provided the default configuration from the RobotModule will be used)</span>
<span class="n">t</span><span class="o">-&gt;</span><span class="n">configure</span><span class="p">(</span><span class="n">stabiConf</span><span class="p">);</span>
<span class="c1">// Set contacts (optional, the stabilizer will be configured in double support using the current foot pose as target for each contact by default)</span>
<span class="n">t</span><span class="o">-&gt;</span><span class="n">setContacts</span><span class="p">({</span><span class="n">ContactState</span><span class="o">::</span><span class="n">Left</span><span class="p">,</span> <span class="n">ContactState</span><span class="o">::</span><span class="n">Right</span><span class="p">});</span>
</code></pre></div></div>

<p>Additionally, you may load additional configuration settings and targets from an <code class="language-plaintext highlighter-rouge">mc_rtc::Configuration</code> object:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Load default configuration from robot module</span>
<span class="k">auto</span> <span class="n">stabiConf</span> <span class="o">=</span> <span class="n">robot</span><span class="p">().</span><span class="n">module</span><span class="p">().</span><span class="n">defaultLIPMStabilizerConfiguration</span><span class="p">();</span>
<span class="c1">// mc_rtc::Configuration object containing valid stabilizer configuration (see JSON schema documentation)</span>
<span class="k">auto</span> <span class="n">conf</span> <span class="o">=</span> <span class="p">...</span>
<span class="c1">// Optional: Load additional configuration from an mc_rtc::Configuration object</span>
<span class="n">stabiConf</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
<span class="c1">// Create the stabilizer task</span>
<span class="k">auto</span> <span class="n">t</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">mc_tasks</span><span class="o">::</span><span class="n">lipm_stabilizer</span><span class="o">::</span><span class="n">StabilizerTask</span><span class="o">&gt;</span><span class="p">(</span>
          <span class="n">solver</span><span class="p">().</span><span class="n">robots</span><span class="p">(),</span>
          <span class="n">solver</span><span class="p">().</span><span class="n">realRobots</span><span class="p">(),</span>
          <span class="n">robotIndex</span><span class="p">,</span>
          <span class="n">stabiConf</span><span class="p">.</span><span class="n">leftFootSurface</span><span class="p">,</span>
          <span class="n">stabiConf</span><span class="p">.</span><span class="n">rightFootSurface</span><span class="p">,</span>
          <span class="n">stabiConf</span><span class="p">.</span><span class="n">torsoBodyName</span><span class="p">,</span>
          <span class="n">solver</span><span class="p">().</span><span class="n">dt</span><span class="p">());</span>
<span class="c1">// Reset the task</span>
<span class="n">t</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">();</span>
<span class="c1">// Apply stabilizer configuration</span>
<span class="n">t</span><span class="o">-&gt;</span><span class="n">configure</span><span class="p">(</span><span class="n">stabiConf</span><span class="p">);</span>
<span class="c1">// Load additional properties from configuration (contact targets, com target, etc)</span>
<span class="n">t</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
</code></pre></div></div>

<p>By default, if no contacts and targets are specified, the task will start in double support and attempt to maintain the current feet pose and CoM position of the control robot. You may give targets to the stabilizer using <code class="language-plaintext highlighter-rouge">StabilizerTask::target(com, comd, comdd, zmp)</code> (see above).</p>

<h2 id="using-the-stabilizer-fsm">Using the Stabilizer (FSM)</h2>

<p>The previous sections have introduced generalities about the stabilizer, how to create it and configure its gains. Using it is now as simple as selecting the appropriate contact mode (left support, right support, double support), and providing a valid reference state. Additionally, for the most common use-cases, <code class="language-plaintext highlighter-rouge">FSM</code> facilities are provided to help with its use.</p>

<p>A default FSM state <code class="language-plaintext highlighter-rouge">StabilizerStandingState</code> is provided. This state automatically creates a stabilizer task from configuration, and provides simple targets to the <code class="language-plaintext highlighter-rouge">CoM</code> and <code class="language-plaintext highlighter-rouge">Contacts</code>. The trajectory of the CoM is computed according to a simple spring-damper, and dynamic pendulum references are computed using a LIPM pendulum model. This reference is given to the stabilizer at every timestep.</p>

<p>You can configure the state in <code class="language-plaintext highlighter-rouge">YAML</code> as follows</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">##</span>
<span class="c1"># This state keeps the robot standing at it's current position in double support</span>
<span class="c1">##</span>
<span class="s">Stabilizer::Standing:</span>
  <span class="s">base</span><span class="pi">:</span> <span class="s">StabilizerStandingState</span>
  <span class="s"># This stiffness controls the spring-damper computation of the reference CoM position</span>
  <span class="s"># damping is automatically computed as 2*sqrt(stiffness)</span>
  <span class="s">stiffness</span><span class="pi">:</span> <span class="m">5</span>
  <span class="c1"># StabilizerTask configuration (see previous section)</span>
  <span class="na">StabilizerConfig</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">lipm_stabilizer</span>
    <span class="na">leftFootSurface</span><span class="pi">:</span> <span class="s">LeftFootCenter</span>
    <span class="na">rightFootSurface</span><span class="pi">:</span> <span class="s">RightFootCenter</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">contacts</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Left</span><span class="pi">,</span> <span class="nv">Right</span><span class="pi">]</span>
</code></pre></div></div>

<p>Using this state, it is very easy to move the CoM (or keep it at a desired position)</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">##</span>
<span class="c1"># Make the CoM move to a point centered above both of the robot's feet contact</span>
<span class="c1">#</span>
<span class="c1"># Completion:</span>
<span class="c1"># - OK when the dcm reaches the provided threshold</span>
<span class="c1">##</span>
<span class="s">Stabilizer::GoCenter:</span>
  <span class="s">base</span><span class="pi">:</span> <span class="s">Stabilizer::Standing</span>
  <span class="s">above</span><span class="pi">:</span> <span class="s">Center</span>
  <span class="s">completion</span><span class="pi">:</span>
    <span class="na">dcmEval</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0.005</span><span class="pi">,</span> <span class="nv">0.005</span><span class="pi">,</span> <span class="nv">0.05</span><span class="pi">]</span>

<span class="c1">##</span>
<span class="c1"># Make the CoM move to a point above the left foot ankle</span>
<span class="c1">##</span>
<span class="s">Stabilizer::GoLeft:</span>
  <span class="s">base</span><span class="pi">:</span> <span class="s">Stabilizer::GoCenter</span>
  <span class="s">above</span><span class="pi">:</span> <span class="s">LeftAnkle</span>

<span class="c1">##</span>
<span class="c1"># Make the CoM move to a point above the right foot ankle</span>
<span class="c1">##</span>
<span class="s">Stabilizer::GoRight:</span>
  <span class="s">base</span><span class="pi">:</span> <span class="s">Stabilizer::GoLeft</span>
  <span class="s">above</span><span class="pi">:</span> <span class="s">RightAnkle</span>
</code></pre></div></div>

<p>A simple library of predefined states for the most common actions (including the ones above) is provided in <code class="language-plaintext highlighter-rouge">mc_control/fsm/states/data/StabilizerStanding.yaml</code>. These states are intended to be put in parallel to other states to achieve more complex actions, such as the ones showcased in the next section.</p>

<h2 id="lipmstabilizer-sample-fsm">LIPMStabilizer sample FSM</h2>

<p>To get started with the stabilizer, the user may refer to the provided sample controller <code class="language-plaintext highlighter-rouge">LIPMStabilizer</code>. To test it, simply add the following to your <code class="language-plaintext highlighter-rouge">mc_rtc.yaml</code> configuration file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Enabled</span><span class="pi">:</span> <span class="s">LIPMStabilizer</span>
</code></pre></div></div>

<p>And run an interface supporting dynamic simulation (such as <code class="language-plaintext highlighter-rouge">mc_vrep</code> or <code class="language-plaintext highlighter-rouge">choreonoid</code>). This default FSM lets you move the CoM from left to right foot, and provides the following FSMs:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Stabilizer::Standing</code> : keeps the CoM at its current observed position. While in this state, you can freely move the CoM from <code class="language-plaintext highlighter-rouge">Left</code> to <code class="language-plaintext highlighter-rouge">Right</code> ankle in the GUI, or any other position. You may go to the “Tasks-&gt;Stabilizer” tab to see and modify the stabilizer gains. Additionally the “Debug” tab lets you add live plots visualizing the stabilizer behaviour.</li>
  <li><code class="language-plaintext highlighter-rouge">AlternateFeetLifting</code> : alternatively lift the left and right foot. This is essentially a quasi-static motion, where the <code class="language-plaintext highlighter-rouge">StabilizerStandingState</code> is used to move the CoM above the left (resp right) ankle, configure the stabilizer in single support, then use it in parallel to tasks on the right (resp. left) swing foot (<code class="language-plaintext highlighter-rouge">SurfaceTransform</code> for the liftoff phase, <code class="language-plaintext highlighter-rouge">AdmittanceTask</code> for putting the foot down).</li>
  <li><code class="language-plaintext highlighter-rouge">AlternateFeetLiftingManual</code>: same as above, but transitions are triggered by the user. Useful to tune the stabilizer’s behaviour</li>
  <li><code class="language-plaintext highlighter-rouge">StepForward</code>: performs one <code class="language-plaintext highlighter-rouge">20cm</code> step foward using a quasi-static motion. If using on a real robot, be careful as the swing foot trajectory is merly a spline with no early/late impact handling.</li>
  <li><code class="language-plaintext highlighter-rouge">StepBackward</code>: performs one <code class="language-plaintext highlighter-rouge">10cm</code> step backward using a quasi-static motion.</li>
</ul>

<h2 id="interacting-with-the-stabilizer-from-another-fsm-states">Interacting with the stabilizer from another FSM states</h2>

<p>The stabilizer states provides a number of callbacks for other states to configure it through the user of the <a href="datastore.html">datastore</a>. The following table lists the available callbacks.</p>

<table class="table">
  <thead>
    <tr>
      <th scope="col">Name</th>
      <th scope="col">Type</th>
      <th scope="col">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>StabilizerStandingState::getCoMTarget</td>
      <td><pre>const Eigen::Vector3d &amp; ()</pre></td>
      <td>Returns the CoM target used by the stabilizer</td>
    </tr>
    <tr>
      <td>StabilizerStandingState::setCoMTarget</td>
      <td><pre>void (const Eigen::Vector3d &amp;)</pre></td>
      <td>Modifies the CoM target used by the stabilizer</td>
    </tr>
    <tr>
      <td>StabilizerStandingState::getStiffness</td>
      <td><pre>double ()</pre></td>
      <td>Returns the CoM tracking stiffness</td>
    </tr>
    <tr>
      <td>StabilizerStandingState::setStiffness</td>
      <td><pre>void (double)</pre></td>
      <td>Modifies the CoM tracking stiffness<br />Also sets damping to 2*sqrt(stiffness)</td>
    </tr>
    <tr>
      <td>StabilizerStandingState::getDamping</td>
      <td><pre>double ()</pre></td>
      <td>Returns the CoM tracking damping</td>
    </tr>
    <tr>
      <td>StabilizerStandingState::setDamping</td>
      <td><pre>void (double)</pre></td>
      <td>Modifies the CoM tracking damping</td>
    </tr>
    <tr>
      <td>StabilizerStandingState::setCoMWeight</td>
      <td><pre>void (double)</pre></td>
      <td>Modifies the CoM task weight</td>
    </tr>
    <tr>
      <td>StabilizerStandingState::setCoMStiffness</td>
      <td><pre>void (const Eigen::Vector3d &amp;)</pre></td>
      <td>Modifies the CoM task stiffness</td>
    </tr>
    <tr>
      <td>StabilizerStandingState::setPelvisWeight</td>
      <td><pre>void (double)</pre></td>
      <td>Modifies the Pelvis task weight</td>
    </tr>
    <tr>
      <td>StabilizerStandingState::setPelvisStiffness</td>
      <td><pre>void (double)</pre></td>
      <td>Modifies the Pelvis task stiffness</td>
    </tr>
    <tr>
      <td>StabilizerStandingState::setTorsoWeight</td>
      <td><pre>void (double)</pre></td>
      <td>Modifies the Torso task weight</td>
    </tr>
    <tr>
      <td>StabilizerStandingState::setTorsoStiffness</td>
      <td><pre>void (double)</pre></td>
      <td>Modifies the Torso task stiffness</td>
    </tr>
    <tr>
      <td>StabilizerStandingState::getConfiguration</td>
      <td><pre>lipm_stabilizer::StabilizerConfiguration ()</pre></td>
      <td>Returns the stabilizer configuration</td>
    </tr>
    <tr>
      <td>StabilizerStandingState::setConfiguration</td>
      <td><pre>void (const lipm_stabilizer::StabilizerConfiguration &amp;)</pre></td>
      <td>Sets the stabilizer configuration</td>
    </tr>
  </tbody>
</table>

<p>Example:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Adds a GUI element to the controller instance ctl, providing the ability to read and modify the stiffness of the stabilizer</span>
<span class="c1">// This may for instance be used from another FSM state running in parallel with the StabilizerStandingState.</span>
<span class="n">ctl</span><span class="p">.</span><span class="n">gui</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">addElement</span><span class="p">({</span><span class="s">"DatastoreExample"</span><span class="p">},</span>
    <span class="n">mc_rtc</span><span class="o">::</span><span class="n">gui</span><span class="o">::</span><span class="n">NumberInput</span><span class="p">(</span><span class="s">"Stiffness"</span><span class="p">,</span>
      <span class="p">[</span><span class="o">&amp;</span><span class="n">ctl</span><span class="p">]()</span>
      <span class="p">{</span>
        <span class="k">return</span> <span class="n">ctl</span><span class="p">.</span><span class="n">datastore</span><span class="p">().</span><span class="n">call</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"StabilizerStandingState::getStiffness"</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="p">[</span><span class="o">&amp;</span><span class="n">ctl</span><span class="p">](</span><span class="kt">double</span> <span class="n">K</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">ctl</span><span class="p">.</span><span class="n">datastore</span><span class="p">().</span><span class="n">call</span><span class="p">(</span><span class="s">"StabilizerStandingState::setStiffness"</span><span class="p">,</span> <span class="n">K</span><span class="p">);</span>
      <span class="p">}));</span>
</code></pre></div></div>


        <hr/>
        
        <div class="text-right">
        <a href="/mc_rtc/tutorials/recipes/speed-constraint.html">Next tutorial: Constraint the speed of a body</a>
        </div>
        
      </div>
      </div>
    </div>

    <div class="container-fluid">
      <footer>
        <hr>
        <div class="row">
          <div class="col-8 offset-lg-2 col-lg-6">
            Copyright &copy; CNRS-AIST JRL, CNRS LIRMM 2015-2020
          </div>
          <div class="col-4 col-lg-2 text-right">
            <a href="/mc_rtc/credits.html">Credits</a>
          </div>
        </div>
      </footer>
    </div>
  </body>

</html>
