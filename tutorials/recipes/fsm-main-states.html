




  

  

  

  
    
    
    

<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="">

<link rel="apple-touch-icon" sizes="180x180" href="/mc_rtc/assets/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/mc_rtc/assets/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/mc_rtc/assets/favicons/favicon-16x16.png">
<link rel="manifest" href="/mc_rtc/assets/favicons/site.webmanifest">
<link rel="mask-icon" href="/mc_rtc/assets/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js"></script>





<link href="/mc_rtc/css/mc_rtc.css" rel="stylesheet">

    <title>Tutorials - Main FSM states - mc_rtc</title>
  </head>

  <body>
    <header class="navbar navbar-expand-lg navbar-light bg-light sticky-top" role="navigation">
  <a class="navbar-brand" href="/mc_rtc/index.html"><img src="/mc_rtc/assets/logo.png" alt="logo" width="30" height="30"/> mc_rtc</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarText">
    <div class="navbar-nav mr-auto">
      
        
        
        <a class="nav-item nav-link " href="/mc_rtc/interfaces.html">Interfaces</a>
      
        
        
        <a class="nav-item nav-link " href="/mc_rtc/robots.html">Robots</a>
      
        
        
        <a class="nav-item nav-link active" href="/mc_rtc/tutorials.html">Tutorials</a>
      
        
        
        <a class="nav-item nav-link " href="/mc_rtc/doxygen.html">API documentation</a>
      
        
        
        <a class="nav-item nav-link " href="/mc_rtc/json.html">JSON/YAML documentation</a>
      
      <a class="nav-item nav-link" href="https://mc-rtc-demo.netlify.app/" target="blank_">Online demonstration</a>
    </div>
    
      
      
      
      EN
      
      
        &nbsp;|&nbsp;
      
    
      
      
      
        <a href="/mc_rtc/jp/tutorials/recipes/fsm-main-states.html">
      
      JP
      
        </a>
      
      
        &nbsp;&nbsp;&nbsp;
      
    
    <a href="https://github.com/jrl-umi3218/mc_rtc" target="blank_"><svg height="25" width="25" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg></a>
  </div>
</header>


    <div class="container-fluid">
      <div class="row">
      <div class="col col-lg-3">
        <div class="sticky-top sticky-toc">
          <div class="accordion" id="accordionTutorials">
            <div class="card">
              <div class="card-header" id="headingOtherTutorials">
                <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapseOtherTutorials" aria-expanded="true" aria-controls="collapseOtherTutorials">
                  Other tutorials
                </button>
              </div>
              <div id="collapseOtherTutorials" class="collapse" arial-labelledby="headingOtherTutorials" data-parent="#accordionTutorials">
                <div class="card-body">
                  <ul>
                    
                    <li>Introduction</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/installation-guide.html">Installation guide</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/configuration.html">Configuring mc_rtc and its components</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/running-a-controller.html">Running a controller</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/first-controller.html">Your first controller with mc_rtc</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/com-controller.html">Controlling the CoM</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/ef-controller.html">Controlling an end-effector (and loading)</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/introduction/multi-robot-controller.html">Multi-robot controller</a></li>
                        
                      
                    </ul>
                    
                    <li>Framework usage</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/mc_rtc_configuration.html"><code>mc_rtc::Configuration</code> general purpose configuration</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/logging.html">Logging data</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/console-logging.html">Printing information to the screen</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/gui.html">Graphical User Interface (GUI)</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/live-plotting.html">Display plots live from the controller</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/ros.html">ROS integration</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/usage/global-plugins.html">Using global plugins</a></li>
                        
                      
                    </ul>
                    
                    <li>Framework tools</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_log_utils.html">Log manipulation</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_log_ui.html">Log plotting</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_log_visualization.html">Replay visualization</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_surfaces_visualization.html">Visualizing surfaces</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/tools/mc_convex_visualization.html">Visualizing convexes</a></li>
                        
                      
                    </ul>
                    
                    <li>Control recipes</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/fsm.html">Using the FSM facilities</a></li>
                        
                      
                        
                        <li><strong>Main FSM states</strong></li>
                          
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/fsm-example.html">FSM controller in practice</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/derived-fsm.html">Deriving the FSM controller</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/datastore.html">DataStore: Sharing Objects</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/observers.html">State Observation Pipelines</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/lipm-stabilizer.html">Using the LIPM Stabilizer</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/speed-constraint.html">Constraint the speed of a body</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/moving-a-contact.html">Moving a contact</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/contact-dof.html">Change the DoF constraints on a contact</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/joint-select.html">Select specific joints for a task</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/dim-weight.html">Affect different weight to different axis in the task space</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/joint-stiffness.html">Joints Stiffness</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/recipes/com-constraint.html">Constraining the accessible region of the CoM</a></li>
                        
                      
                    </ul>
                    
                    <li>Samples</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/samples/list-of-samples.html">Available sample controllers</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/samples/sample-admittance.html">Admittance sample controller</a></li>
                        
                      
                    </ul>
                    
                    <li>Advanced topics</li>
                    <ul>
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/new-plugin.html">Implement a new plugin for mc_rtc</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/new-interface.html">Implement a new mc_rtc interface</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/new-environment.html">Environment creation for mc_rtc</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/new-robot.html">Integrate a new robot in mc_rtc</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/support-mc-rtc-build-static.html">Supporting MC_RTC_BUILD_STATIC in your code</a></li>
                        
                      
                        
                        <li><a href="/mc_rtc/tutorials/advanced/debug-lssol-output-6.html">Debugging LSSOL output 6</a></li>
                        
                      
                    </ul>
                    
                  </ul>
                </div>
              </div>
              
                <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#metatasks-state">MetaTasks state</a>
<ul>
<li class="toc-entry toc-h3"><a href="#completion-criterias">Completion criterias</a></li>
<li class="toc-entry toc-h3"><a href="#state-output">State output</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#parallel-state">Parallel state</a>
<ul>
<li class="toc-entry toc-h3"><a href="#interacting-between-parallel-states">Interacting between parallel states</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#meta-fsm-within-an-fsm">Meta: FSM within an FSM</a></li>
</ul>
              
            </div>
          </div>
        </div>
      </div>
      <div class="col-9" id="tutorial-content">
        
        <h1>Main FSM states</h1>
        

        <p>The framework provides by default a few pre-implemented states intended to make it easy to take full advantage of the <code class="language-plaintext highlighter-rouge">JSON/YAML</code> configuration capabilities of the FSM. Using these, writing FSMs for complex robot behaviours becomes easy, and usually involves little to no handwritten <code class="language-plaintext highlighter-rouge">C++/Python</code> states: almost everything can be directly described in the FSM configuration. In this tutorial, we’ll explore use of the three most useful states:</p>

<ul>
  <li><a href="/mc_rtc/json.html#State/MetaTasks">MetaTasks</a>: Loads a set of tasks from their <code class="language-plaintext highlighter-rouge">JSON/YAML</code> configuration</li>
  <li><a href="/mc_rtc/json.html#State/Parallel">Parallel</a>: Runs multiple states in “parallel”</li>
  <li><a href="/mc_rtc/json.html#State/Meta">Meta</a>: Nests an FSM within an FSM</li>
</ul>

<p>In the remainder of this tutorial, we’ll see how these may be used. Only <code class="language-plaintext highlighter-rouge">YAML</code> examples will be shown, <code class="language-plaintext highlighter-rouge">JSON</code> is of course also supported and similar examples may be found in the documentation. A full list of available states can be found in the <a href="/mc_rtc/json.html#State">“State objects”</a> section of the JSON/YAML documentation.</p>

<h2 id="metatasks-state">MetaTasks state</h2>

<p>The <code class="language-plaintext highlighter-rouge">MetaTasks</code> state (<a href="/mc_rtc/json.html#State/MetaTasks">documentation</a>) allows to load a list of tasks from their <code class="language-plaintext highlighter-rouge">JSON/YAML</code> configuration. The full list of available tasks is available <a href="/mc_rtc/json.html#MetaTask">JSON/YAML documentation</a>.</p>

<p>Let’s start with an example, we will add a new <code class="language-plaintext highlighter-rouge">MetaTasks</code> state in the <code class="language-plaintext highlighter-rouge">states:</code> section of the <code class="language-plaintext highlighter-rouge">FSM</code> configuration.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">states</span><span class="pi">:</span>
  <span class="na">ExampleState</span><span class="pi">:</span>
    <span class="na">base</span><span class="pi">:</span> <span class="s">MetaTasks</span>
    <span class="c1"># optional: uses the output criteria of the tasks as the string output for the next transition</span>
    <span class="na">outputs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">CoM</span><span class="pi">]</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="c1"># create a CoM task</span>
      <span class="na">CoM</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com</span>
        <span class="na">move_com</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0</span><span class="pi">,</span> <span class="nv">0</span><span class="pi">,</span> <span class="nv">-0.05</span><span class="pi">]</span>
        <span class="na">completion</span><span class="pi">:</span>
          <span class="na">OR</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">timeout</span><span class="pi">:</span> <span class="m">3</span>
            <span class="pi">-</span> <span class="na">AND</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">eval</span><span class="pi">:</span> <span class="m">0.01</span>
              <span class="pi">-</span> <span class="na">speed</span><span class="pi">:</span> <span class="m">0.005</span>

      <span class="c1"># create a bspline_trajectory task</span>
      <span class="na">HandTrajectory</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">bspline_trajectory</span>
        <span class="na">surface</span><span class="pi">:</span> <span class="s">LeftHand</span>
        <span class="na">stiffness</span><span class="pi">:</span> <span class="m">10000.0</span>
        <span class="na">duration</span><span class="pi">:</span> <span class="m">15.0</span>
        <span class="na">weight</span><span class="pi">:</span> <span class="m">100</span>
        <span class="na">targetSurface</span><span class="pi">:</span>
          <span class="c1"># assumes that the additional object/box robot was loaded in the global fsm configuration</span>
          <span class="na">robot</span><span class="pi">:</span> <span class="s">box</span>
          <span class="na">surface</span><span class="pi">:</span> <span class="s">Left</span>
        <span class="na">completion</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">timeElapsed</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<p>This will create a new state named <code class="language-plaintext highlighter-rouge">ExampleState</code> that will itself loads:</p>
<ul>
  <li>A <code class="language-plaintext highlighter-rouge">CoM</code> task named <code class="language-plaintext highlighter-rouge">CoM</code> that moves the com <code class="language-plaintext highlighter-rouge">5cm</code> down.</li>
  <li>A <code class="language-plaintext highlighter-rouge">BSplineTrajectory</code> task named <code class="language-plaintext highlighter-rouge">LeftHandTrajectory</code> that moves the left gripper of the robot to a surface <code class="language-plaintext highlighter-rouge">Left</code> defined on another robot.</li>
</ul>

<h3 id="completion-criterias">Completion criterias</h3>

<p>Notice the <code class="language-plaintext highlighter-rouge">completion</code> elements in the example above. These are what we refer to as “completion criteria”. They are a way to generate conditional statements to determine when a task has been completed. See the API documentation for <a href="/mc_rtc/doxygen.html#structmc__control_1_1CompletionCriteria" target="blank_"><code>mc_control::CompletionCriteria</code></a> for details.</p>

<p>By default, every task defines the following entries:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">eval</code>: True when the norm of MetaTask::eval() is below the provided value</li>
  <li><code class="language-plaintext highlighter-rouge">speed</code>: True when the norm of MetaTask::speed() is below the provided value</li>
  <li><code class="language-plaintext highlighter-rouge">timeout</code>: True when the task has been added to the solver longer than the provided time (in seconds)</li>
</ul>

<p>Some tasks define additional completion criterias, such as:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">SplineTrajectoryTask</code> variants (<code class="language-plaintext highlighter-rouge">bspline_trajectory</code>, <code class="language-plaintext highlighter-rouge">exact_cubic_trajectory</code>) additionally define
    <ul>
      <li><code class="language-plaintext highlighter-rouge">timeElapsed: true</code>: True when the task <code class="language-plaintext highlighter-rouge">duration</code> has elapsed</li>
      <li><code class="language-plaintext highlighter-rouge">wrench</code>: True when the force applied on the robot surface is higher than the provided threshold (6d vector, NaN value ignores the reading, negative values invert the condition). Ignored if the surface has no force-sensor attached.</li>
    </ul>
  </li>
</ul>

<p>You may add your own completion criterias by implementing <code class="language-plaintext highlighter-rouge">mc_task::MetaTask::buildCompletionCriteria</code> for your task. These completion criterias can be combined using the conditional constructs <code class="language-plaintext highlighter-rouge">AND</code> and <code class="language-plaintext highlighter-rouge">OR</code> as follows. The usual rules of lazy evaluation apply. For example, to check whether the hand trajectory tasks has completed if its total duration has been reached or more than 15N apply along the <code class="language-plaintext highlighter-rouge">z</code> direction of the hand’s surface normal after 3 seconds of delay, you could write:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># completion criteria that checks whether a trajectory task has been active for at least its specified duration</span>
<span class="c1"># or whether more than 15N apply along the `z` direction of the hand surface after 3 seconds of delay.</span>
<span class="na">completion</span><span class="pi">:</span>
  <span class="na">OR</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">timeElapsed</span><span class="pi">:</span> <span class="no">true</span>
    <span class="pi">-</span> <span class="na">AND</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">timeout</span><span class="pi">:</span> <span class="m">3</span>
      <span class="pi">-</span> <span class="na">wrench</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">.NaN</span><span class="pi">,</span> <span class="nv">.NaN</span><span class="pi">,</span> <span class="nv">.NaN</span><span class="pi">,</span> <span class="nv">.NaN</span><span class="pi">,</span> <span class="nv">.NaN</span><span class="pi">,</span> <span class="nv">15</span><span class="pi">]</span>
</code></pre></div></div>

<p>You may also ommit the <code class="language-plaintext highlighter-rouge">completion</code> criteria for tasks that you want to execute but whose completion does not matter. In that case the FSM will consider the task as always completed.</p>

<h3 id="state-output">State output</h3>

<p>As mentioned in the previous tutorials, each state returns an output string by calling <code class="language-plaintext highlighter-rouge">State::output("output value")</code>. This output value is used in the transition map to determine which state should be exectuted next. By default, the <code class="language-plaintext highlighter-rouge">MetaTasks</code> state returns <code class="language-plaintext highlighter-rouge">"OK"</code> once all of its tasks have completed. If you don’t need to take branching decisions based on the tasks outputs, then your transition map would look like</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">transtions</span><span class="pi">:</span>
<span class="nn">...</span>
<span class="c1"># transition to the next state automatically when all tasks have completed</span>
<span class="pi">-</span> <span class="pi">[</span><span class="nv">ExampleState</span><span class="pi">,</span> <span class="nv">OK</span><span class="pi">,</span> <span class="nv">NextState</span><span class="pi">,</span> <span class="nv">Auto</span><span class="pi">]</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>You may however want to make more complex branching decisions based on why the tasks have completed. For this, the <code class="language-plaintext highlighter-rouge">MetaTasks</code> state defines an <code class="language-plaintext highlighter-rouge">output</code> configuration which may contain a list of tasks names for which the completion criteria’s string output will be used to generate the state’s output. For example:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">ExampleState</span><span class="pi">:</span>
  <span class="na">base</span><span class="pi">:</span> <span class="s">MetaTasks</span>
  <span class="c1"># optional: uses the output criteria of the tasks as the string output for the next transition</span>
  <span class="na">outputs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">CoM</span><span class="pi">]</span>
</code></pre></div></div>

<p>Your transition map can now branch conditionally based on the <code class="language-plaintext highlighter-rouge">CoM</code> completion criteria:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Reminder: the CoM completion criteria is defined as:</span>
<span class="c1"># CoM:</span>
<span class="c1">#   completion:</span>
<span class="c1">#     OR:</span>
<span class="c1">#       - timeout: 3</span>
<span class="c1">#       - AND:</span>
<span class="c1">#         - eval: 0.01</span>
<span class="c1">#         - speed: 0.005</span>
<span class="pi">-</span> <span class="pi">[</span><span class="nv">ExampleState</span><span class="pi">,</span> <span class="s2">"</span><span class="s">CoM=timeout"</span><span class="pi">,</span> <span class="nv">CoMHasNotConvergedState</span><span class="pi">,</span> <span class="nv">Auto</span><span class="pi">]</span>
<span class="pi">-</span> <span class="pi">[</span><span class="nv">ExampleState</span><span class="pi">,</span> <span class="s2">"</span><span class="s">CoM=eval</span><span class="nv"> </span><span class="s">AND</span><span class="nv"> </span><span class="s">speed"</span><span class="pi">,</span> <span class="nv">NextMotionState</span><span class="pi">,</span> <span class="nv">Auto</span><span class="pi">]</span>
<span class="c1"># state to execute by default if none of the completion patterns are matched in the transition map</span>
<span class="c1"># This allows to define non-exhaustive matching patterns in the transition map</span>
<span class="pi">-</span> <span class="pi">[</span><span class="nv">ExampleState</span><span class="pi">,</span> <span class="s2">"</span><span class="s">DEFAULT"</span><span class="pi">,</span> <span class="nv">DefaultState</span><span class="pi">,</span> <span class="nv">Auto</span><span class="pi">]</span>
</code></pre></div></div>

<p>You may now define three new states:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">CoMHasNotConvergedState</code> to be executed if the CoM task hasn’t converged in the allowed time</li>
  <li><code class="language-plaintext highlighter-rouge">NextMotionState</code> to continue moving since the CoM converged</li>
  <li><code class="language-plaintext highlighter-rouge">DefaultState</code> to be executed in case no transition matches the generated output pattern. In this example the matching is exhaustive, and this state would never be executed.</li>
</ul>

<h2 id="parallel-state">Parallel state</h2>

<p>The parallel state (<a href="/mc_rtc/json.html#State/Parallel">documentation</a>) allows to execute multiple states in parallel. Since the FSM execution is actually single-threaded, the states are actually executed sequentially in a single controller iteration.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define an additional MetaTasks state that moves the right hand</span>
<span class="na">RightHandState</span><span class="pi">:</span>
  <span class="na">base</span><span class="pi">:</span> <span class="s">MetaTasks</span>
  <span class="na">HandTrajectory</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">bspline_trajectory</span>
    <span class="na">surface</span><span class="pi">:</span> <span class="s">RightHand</span>
    <span class="na">stiffness</span><span class="pi">:</span> <span class="m">10000.0</span>
    <span class="na">duration</span><span class="pi">:</span> <span class="m">15.0</span>
    <span class="na">weight</span><span class="pi">:</span> <span class="m">100</span>
    <span class="na">targetSurface</span><span class="pi">:</span>
      <span class="na">robot</span><span class="pi">:</span> <span class="s">box</span>
      <span class="na">surface</span><span class="pi">:</span> <span class="s">Left</span>
    <span class="na">completion</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">timeElapsed</span><span class="pi">:</span> <span class="no">true</span>

<span class="c1"># Now say we want to move both the left and right hand and move the CoM down?</span>
<span class="c1"># Easy, simply put the two states in parallel:</span>
<span class="na">ExampleParallelState</span><span class="pi">:</span>
  <span class="na">base</span><span class="pi">:</span> <span class="s">Parallel</span>
  <span class="c1"># At each iteration, the ExampleState will be executed, followed by the RightHandState</span>
  <span class="na">states</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">ExampleState</span><span class="pi">,</span> <span class="nv">RightHandState</span><span class="pi">]</span>
  <span class="c1"># optional defines which state to use as the output criteria</span>
  <span class="c1"># By default the last state's output in the states list above is used</span>
  <span class="na">outputs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">ExampleState</span><span class="pi">,</span> <span class="nv">RightHandState</span><span class="pi">]</span>
</code></pre></div></div>

<p>Parallel states are considered completed when all of its states have completed. As for the <code class="language-plaintext highlighter-rouge">MetaTasks</code> state, it is possible to specify how the state output is generated:</p>
<ul>
  <li>By default, the output of the last state in <code class="language-plaintext highlighter-rouge">states</code> list will be used.</li>
  <li>When <code class="language-plaintext highlighter-rouge">outputs</code> is specified, these states’ outputs will be used to generate the <code class="language-plaintext highlighter-rouge">parallel state</code>’s output.</li>
</ul>

<p>For example:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">ExampleParallelState</span><span class="pi">,</span> <span class="s2">"</span><span class="s">ExampleState:</span><span class="nv"> </span><span class="s">(CoM=timeout),</span><span class="nv"> </span><span class="s">RightHandState:</span><span class="nv"> </span><span class="s">(timeElapsed)"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">StateA"</span><span class="pi">]</span>
<span class="pi">[</span><span class="nv">ExampleParallelState</span><span class="pi">,</span> <span class="s2">"</span><span class="s">ExampleState:</span><span class="nv"> </span><span class="s">(CoM=eval</span><span class="nv"> </span><span class="s">AND</span><span class="nv"> </span><span class="s">speed),</span><span class="nv"> </span><span class="s">RightHandState:</span><span class="nv"> </span><span class="s">(timeElapsed)"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">StateB"</span><span class="pi">]</span>
<span class="c1"># Here the interest of having a default state becomes apparent,</span>
<span class="c1"># as for complex condition criterias it might be cumbersome to create an exhaustive list of possible outputs.</span>
<span class="pi">[</span><span class="nv">ExampleParallelState</span><span class="pi">,</span> <span class="s2">"</span><span class="s">DEFAULT"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">DefaultState"</span><span class="pi">]</span>
</code></pre></div></div>

<h3 id="interacting-between-parallel-states">Interacting between parallel states</h3>

<p>Sometimes it is useful to be able to interact between states. For instance consider a <code class="language-plaintext highlighter-rouge">StabilizerStandingState</code> in parallel to a <code class="language-plaintext highlighter-rouge">Pickup</code> state that wants to pick-up an object on the floor. This state needs to move the <code class="language-plaintext highlighter-rouge">CoM</code> lower to enable the robot to reach. This kind of interaction between states can be achieved using the <a href="/mc_rtc/tutorials/recipes/datastore.html">DataStore</a>.</p>

<h2 id="meta-fsm-within-an-fsm">Meta: FSM within an FSM</h2>

<p>In complex scenarios, it is often useful to be able to have multiple FSMs in the same controller. That’s what the <code class="language-plaintext highlighter-rouge">Meta</code> state (<a href="/mc_rtc/json.html#State/Meta">documentation</a>) is for, it embeds an <code class="language-plaintext highlighter-rouge">FSM</code> within an <code class="language-plaintext highlighter-rouge">FSM</code> state.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">ExampleMetaState</span><span class="pi">:</span>
  <span class="na">base</span><span class="pi">:</span> <span class="s">Meta</span>
  <span class="na">transitions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="nv">StateA</span><span class="pi">,</span> <span class="nv">OK</span><span class="pi">,</span> <span class="nv">StateB</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="nv">StateB</span><span class="pi">,</span> <span class="nv">OK</span><span class="pi">,</span> <span class="nv">StateC</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="s">...</span>
</code></pre></div></div>

<p>This state can then be exectued as part of another FSM, or even as part of another <code class="language-plaintext highlighter-rouge">Meta</code> state.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">transtions</span><span class="pi">:</span>
<span class="pi">-</span> <span class="pi">[</span><span class="nv">ExampleParallelState</span><span class="pi">,</span> <span class="nv">DEFAULT</span><span class="pi">,</span> <span class="nv">ExampleMetaState</span><span class="pi">]</span>
<span class="pi">-</span> <span class="pi">[</span><span class="nv">ExampleMetaState</span><span class="pi">,</span> <span class="nv">OK</span><span class="pi">,</span> <span class="nv">LastStateOutput</span><span class="pi">]</span>
</code></pre></div></div>

<p>Note that the ouput of a Meta FSM is the output of its last state without a transition within the Meta FSM (here <code class="language-plaintext highlighter-rouge">LastStateOutput</code>).</p>



        <hr/>
        
        <div class="text-right">
          <a href="/mc_rtc/tutorials/recipes/fsm-example.html">Next tutorial: FSM controller in practice</a>
        </div>
        
      </div>
      </div>
    </div>

    <div class="container-fluid">
  <footer>
    <hr>
    <div class="row">
      <div class="col-8 offset-lg-2 col-lg-6">
        Copyright &copy; CNRS-AIST JRL, CNRS LIRMM 2015-2020
      </div>
      <div class="col-4 col-lg-2 text-right">
        <a href="/mc_rtc/credits.html">Credits</a>
      </div>
    </div>
  </footer>
</div>

  </body>

  <script type="text/javascript">
$(document).ready(function()
{
  new ClipboardJS('.copy-button');
});
</script>


</html>
